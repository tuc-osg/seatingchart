\NeedsTeXFormat{LaTeX2e}[2022-06-01]
\def\packagename{tucseating}
\ProvidesPackage{\packagename}[2025-08-01 v0.1]
\RequirePackage{luacode}
\RequirePackage{translator}
\IfFormatAtLeastTF{2022/06/01}{}{
  \PackageError{\packagename}{
    \packagename requires at least the TeX format \MessageBreak
    from 2022/06. \MessageBreak
  }{Update your LaTeX.}
}
\RequirePackage{tikz}
\RequirePackage{etoolbox}
\RequirePackage{iftex}               % f√ºr Test auf Lua(La)TeX
\ifLuaTeX\else
 \PackageError{\packagename}{
   LuaLaTeX is required to use this package. \MessageBreak
   Sorry!
}{Use LuaLaTex.}
\fi
\newtoggle{tucs@rectshapt}
\newtoggle{tucs@rnleft}
\newtoggle{tucs@rnright}
\DeclareKeys[tucseating]{
  room.store = \tucs@room,
  room.usage = load,
  shape.choice: ,
  shape/arc.code:n = {\togglefalse{tucs@rectshapt}},
  shape/rectangle.code:n = {\toggletrue{tucs@rectshapt}},
  shape.usage = preamble,
  rows.store = \tucs@rows,
  rows.usage = preamble,
  seats per row.store = \tucs@seatsperrow,
  seats per row.usage = preamble,
  blackboard.if = tucs@blackboard,
  rownumbers.choice:,
  rownumbers/left.code = { \toggletrue{tucs@rnleft} },
  rownumbers/right.code = { \toggletrue{tucs@rnright} },
  rownumbers/both.code:n = {
    \toggletrue{tucs@rnleft}\toggletrue{tucs@rnright}
  },
  rownumbers/none.code:n = {
    \togglefalse{tucs@rnleft}\togglefalse{tucs@rnright}
  },
  rownumber distance.store= \tucs@rnsep,
  %aisle.store = \tucs@aisle,
  seat empty.store =\tucs@sc@empty,
  seat empty border.store = \tucs@sc@emptyborder,
  seat empty text.store = \tucs@sc@emptytext,
  seat empty font.store = \tucs@s@emptyfont,
  seat assigned.store = \tucs@sc@assigned,
  seat assigned border.store = \tucs@sc@assignedborder,
  seat assigned text.store = \tucs@sc@assignedtext,
  seat assigned font.store = \tucs@s@assignedfont,
  seat background.code:n = {
    \gdef\tucs@sc@empty{#1}
    \gdef\tucs@sc@assigned{#1}
  },
  seat text.code:n = {
    \gdef\tucs@sc@emptytext{#1}
    \gdef\tucs@sc@assignedtext{#1}
  },
  seat border.code:n = {
    \gdef\tucs@sc@emptyborder{#1}
    \gdef\tucs@sc@assignedborder{#1}
  },
  seat font.code:n = {
    \gdef\tucs@s@emptyfont{#1}
    \gdef\tucs@s@assignedfont{#1}
  }
}
% defaults
\SetKeys[tucseating]{
  seat empty border=lightgray,
  seat empty =lightgray!20,
  seat empty text =lightgray!20,
  seat assigned = lightgray!30,
  seat assigned border = black,
  seat font = \tiny,
  seat assigned text = black,
  blackboard = false,
  rownumber distance = 2pt
}
\ProcessKeyOptions
\usetikzlibrary{shapes.geometric}


\NewDocumentCommand{\tucsInitSeating}{o}{
  \luadirect{require("tucseating.lua")}
  \luadirect{initRec(\tucs@rows,\tucs@seatsperrow)}
}
\NewDocumentCommand{\tucsConfig}{m}{
  \SetKeys[tucseating]{#1}%
  \tucs@configtikz%
}
\newcommand{\tucsrownumformat}[1]{
  \tiny#1
}
\newcommand{\tucsassignedlabelformat}[1]{%
  \small#1
}
\newcommand{\tucemptylabelformat}[1]{%
}

\newcommand\tucs@configtikz{
  \tikzset{
    empty seat/.style={
      draw=\tucs@sc@emptyborder,
      fill=\tucs@sc@empty,
      font=\tucs@s@emptyfont,
      text=\tucs@sc@empty,
      inner sep=0.5pt
    },
    empty label/.style={
      text=\tucs@sc@emptytext,
      font=\tucs@s@emptyfont
    },
    assigned seat/.style={
      draw=\tucs@sc@assignedborder,
      fill=\tucs@sc@assigned,
      text=\tucs@sc@assigned,
      font=\tucs@s@assignedfont,
      inner sep=0.5pt
    },
    assigned label/.style={
      text=\tucs@sc@assignedtext,
      font=\tucs@s@assignedfont
    }
  }
}
\NewDocumentCommand{\tucsDrawSeating}{sO{}}{
  \newlength\tucsseatwidth
  \newlength\tucsseatheight
  \newlength\tucsremainingspace
  \newlength\tucstmplen
  \IfBooleanTF{#1}{
    \settowidth{\tucsseatwidth}{xxx}
    \settoheight{\tucsseatheight}{Xy}
  }{
    \setlength{\tucsremainingspace}{\linewidth}
    \typeout{Linewidth: \the\linewidth}
    \settowidth{\tucstmplen}{\tucsrownumformat{99}}
    \typeout{Numswidth: \the\tucstmplen}
    \iftoggle{tucs@rnleft}{\addtolength{\tucsremainingspace}{\dimeval{-\tucstmplen-\tucs@rnsep}}}{}
    \iftoggle{tucs@rnright}{\addtolength{\tucsremainingspace}{\dimeval{-\tucstmplen-\tucs@rnsep}}}{}
    \typeout{Remaining: \the\tucsremainingspace}
    \setlength{\tucsseatwidth}{\dimeval{\tucsremainingspace/\tucs@seatsperrow - 2pt}}

    \setlength{\tucsremainingspace}{\dimeval{\pagegoal-\pagetotal}}
    \setlength{\tucsseatheight}{\dimeval{\tucsremainingspace/(\tucs@rows + 2) - 2pt}}
   
  }
  \luadirect{seatDim(\luastring{\tucsseatwidth},\luastring{\tucsseatheight})}
  \begin{tikzpicture}[x=\tucsseatwidth+2pt,y=\tucsseatheight+2pt]
      \iftucs@blackboard
          \node[rectangle, draw,minimum width=0.4\textwidth] at (0,-2) {Tafel};
      \fi
      \iftoggle{tucs@rnleft}{
            \foreach \r in {1,..., \tucs@rows} {
              \node[anchor=west,xshift=-\tucs@rnsep] at (\fpeval{-(\tucs@seatsperrow+1)/2},\r-1) {\tucsrownumformat{\r}};
            }
          }{}
     \iftoggle{tucs@rnright}{
            \foreach \r in {1,..., \tucs@rows} {
              \node[anchor=east,xshift=\tucs@rnsep] at (\fpeval{(\tucs@seatsperrow+1)/2},\r-1) {\tucsrownumformat{\r}};
            }
          }{}
      \luadirect{drawSeats()}
    \end{tikzpicture}
}

\NewDocumentCommand{\removeSeatAt}{m m}{
  \luadirect{removeSeatAt(#1,#2)}
}
\NewDocumentCommand{\assignSeatAt}{m m m}{
  \luadirect{assignSeatAt(#1,#2,\luastring{#3})}
}
\NewDocumentCommand{\setRowAsAisle}{m}{
}